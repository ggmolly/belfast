-- 0003_identity_defaults.sql
-- Milestone 6: ensure primary keys have defaults where code inserts without IDs.

-- owned_ships.id is inserted without specifying an id.
DO $$
DECLARE
  identity_flag text;
  default_expr text;
  seq_name text;
BEGIN
  SELECT is_identity, column_default
    INTO identity_flag, default_expr
    FROM information_schema.columns
   WHERE table_schema = current_schema()
     AND table_name = 'owned_ships'
     AND column_name = 'id';

  IF identity_flag IS NULL THEN
    RETURN;
  END IF;

  IF identity_flag <> 'YES' AND default_expr IS NULL THEN
    ALTER TABLE owned_ships
      ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
  END IF;

  SELECT pg_get_serial_sequence(format('%I.%I', current_schema(), 'owned_ships'), 'id') INTO seq_name;
  IF seq_name IS NOT NULL THEN
    EXECUTE format(
      'SELECT setval(%L, COALESCE(MAX(id), 1), MAX(id) IS NOT NULL) FROM %I.%I',
      seq_name,
      current_schema(),
      'owned_ships'
    );
  END IF;
END
$$;

-- mails.id / mail_attachments.id are inserted without specifying IDs.
DO $$
DECLARE
  identity_flag text;
  default_expr text;
  seq_name text;
BEGIN
  SELECT is_identity, column_default
    INTO identity_flag, default_expr
    FROM information_schema.columns
   WHERE table_schema = current_schema()
     AND table_name = 'mails'
     AND column_name = 'id';

  IF identity_flag IS NULL THEN
    RETURN;
  END IF;

  IF identity_flag <> 'YES' AND default_expr IS NULL THEN
    ALTER TABLE mails
      ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
  END IF;

  SELECT pg_get_serial_sequence(format('%I.%I', current_schema(), 'mails'), 'id') INTO seq_name;
  IF seq_name IS NOT NULL THEN
    EXECUTE format(
      'SELECT setval(%L, COALESCE(MAX(id), 1), MAX(id) IS NOT NULL) FROM %I.%I',
      seq_name,
      current_schema(),
      'mails'
    );
  END IF;
END
$$;

DO $$
DECLARE
  identity_flag text;
  default_expr text;
  seq_name text;
BEGIN
  SELECT is_identity, column_default
    INTO identity_flag, default_expr
    FROM information_schema.columns
   WHERE table_schema = current_schema()
     AND table_name = 'mail_attachments'
     AND column_name = 'id';

  IF identity_flag IS NULL THEN
    RETURN;
  END IF;

  IF identity_flag <> 'YES' AND default_expr IS NULL THEN
    ALTER TABLE mail_attachments
      ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
  END IF;

  SELECT pg_get_serial_sequence(format('%I.%I', current_schema(), 'mail_attachments'), 'id') INTO seq_name;
  IF seq_name IS NOT NULL THEN
    EXECUTE format(
      'SELECT setval(%L, COALESCE(MAX(id), 1), MAX(id) IS NOT NULL) FROM %I.%I',
      seq_name,
      current_schema(),
      'mail_attachments'
    );
  END IF;
END
$$;

-- builds.id is inserted without specifying an id.
DO $$
DECLARE
  identity_flag text;
  default_expr text;
  seq_name text;
BEGIN
  SELECT is_identity, column_default
    INTO identity_flag, default_expr
    FROM information_schema.columns
   WHERE table_schema = current_schema()
     AND table_name = 'builds'
     AND column_name = 'id';

  IF identity_flag IS NULL THEN
    RETURN;
  END IF;

  IF identity_flag <> 'YES' AND default_expr IS NULL THEN
    ALTER TABLE builds
      ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;
  END IF;

  SELECT pg_get_serial_sequence(format('%I.%I', current_schema(), 'builds'), 'id') INTO seq_name;
  IF seq_name IS NOT NULL THEN
    EXECUTE format(
      'SELECT setval(%L, COALESCE(MAX(id), 1), MAX(id) IS NOT NULL) FROM %I.%I',
      seq_name,
      current_schema(),
      'builds'
    );
  END IF;
END
$$;
